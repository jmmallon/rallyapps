<!DOCTYPE html>
<html>
<head>
    <title>RallyGrid</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._loadReleases()},_loadReleases:function(){var programs=["CGCS","VxWorks ST","IOT","Networking","OVP","Linux","VxWorks 653 3.0","VxWorks 7","Tools"],projectNames=Ext.create("Ext.util.HashMap");projectNames.add("10253738811","Vx-7 Project"),projectNames.add("10479834443","IDP"),projectNames.add("10957142069","Linux OVP"),projectNames.add("11424998698","Vx-7 Infrastructure"),projectNames.add("11424999507","Vx-7 Hardware Arch & BSP"),projectNames.add("11470176273","Linux Core"),projectNames.add("11490019566","Vx-7 Hardware Architecture"),projectNames.add("11490173498","Vx-7 Bootloader"),projectNames.add("12168776634","Workbench 3.3.x"),projectNames.add("12405728916","Tools for Vx-7"),projectNames.add("12868082229","Tools for VxWorks ST"),projectNames.add("12890367855","Vx-7 Platform Enablement Common"),projectNames.add("13245546162","XPD"),projectNames.add("13420058203","IOT"),projectNames.add("13538110755","CGTelcoServer"),projectNames.add("13744307332","VxWorks 653 3.x"),projectNames.add("15106843053","Workbench 3.x"),projectNames.add("15267702952","VxWorks Hypervisor 3.0 Program"),projectNames.add("9740387440","INP");var projectPrograms=Ext.create("Ext.util.HashMap");projectPrograms.add("13538110755","CGCS"),projectPrograms.add("15267702952","VxWorks ST"),projectPrograms.add("10479834443","IOT"),projectPrograms.add("13420058203","IOT"),projectPrograms.add("9740387440","Networking"),projectPrograms.add("13245546162","Networking"),projectPrograms.add("10957142069","OVP"),projectPrograms.add("11470176273","Linux"),projectPrograms.add("13744307332","VxWorks 653 3.0"),projectPrograms.add("10253738811","VxWorks 7"),projectPrograms.add("11490173498","VxWorks 7"),projectPrograms.add("11424999507","VxWorks 7"),projectPrograms.add("11490019566","VxWorks 7"),projectPrograms.add("11424998698","VxWorks 7"),projectPrograms.add("12890367855","VxWorks 7"),projectPrograms.add("12405728916","Tools"),projectPrograms.add("12868082229","Tools"),projectPrograms.add("15106843053","Tools"),projectPrograms.add("12168776634","Tools");var today=Rally.util.DateTime.toIsoString(new Date),releaseDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseDate",operator:">=",value:today}),releaseDatesFilter=releaseDateFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseStartDate",operator:"<=",value:today}));Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["FormattedID","Name","ReleaseDate","ReleaseStartDate"],context:{project:"/project/11089755042",projectScopeDown:!0},limit:1/0,filters:releaseDatesFilter,autoLoad:!0,listeners:{scope:this,load:function(myStore,myData,mySuccess){console.log("Loaded release data: "+myStore.data.length);var releases=Ext.create("Ext.util.HashMap");Ext.Array.each(myStore.getRecords(),function(release){releases.add(release.get("_ref"),[release.get("ReleaseStartDate"),release.get("ReleaseDate")])}),this._loadFeatures(releases,projectNames,projectPrograms,programs)}}})},_addToHash:function(hash,subscript,amount){if(hash.get(subscript)){var hashTmp=hash.get(subscript);hashTmp+=amount,hash.replace(subscript,hashTmp)}else hash.add(subscript,amount)},_loadFeatures:function(releases,projectNames,projectPrograms,programs){Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",fetch:["FormattedID","ObjectID","Name","Release","Project","State","c_PATracking","UserStories"],context:{project:"/project/11089755042",projectScopeDown:!0},limit:1/0,autoLoad:!0,listeners:{scope:this,load:function(myStore,myData,mySuccess){console.log("Loaded feature data: "+myStore.data.length);var total=Ext.create("Ext.util.HashMap"),reviewed=Ext.create("Ext.util.HashMap"),validated=Ext.create("Ext.util.HashMap"),features=Ext.create("Ext.util.HashMap");Ext.Array.each(myStore.getRecords(),function(feature){var featureID=feature.get("ObjectID"),featureFID=feature.get("FormattedID"),featureName=feature.get("Name"),featureRelease=feature.get("Release");if(null!==featureRelease){var featureReleaseRef=featureRelease._ref;if(releases.get(featureReleaseRef)){var featureProject=feature.get("Project"),featureProjectRef=featureProject._ref,featureProjectRefID=featureProjectRef.split("/").pop();if(projectNames.get(featureProjectRefID)&&projectPrograms.get(featureProjectRefID)){features.add(featureID,featureFID+": "+featureName),this._addToHash(total,featureProjectRefID,1);var featureTracking=feature.get("c_PATracking");"Review"==featureTracking&&this._addToHash(reviewed,featureProjectRefID,1);var featureState=feature.get("State");null!==featureState&&(featureStateName=featureState._refObjectName,"Done"==featureStateName&&this._addToHash(validated,featureProjectRefID,1))}}}},this),this._loadUserStories(projectNames,projectPrograms,programs,features,total,reviewed,validated)}}})},_loadUserStories:function(projectNames,projectPrograms,programs,features,total,reviewed,validated){var HLDFilter=Ext.create("Rally.data.wsapi.Filter",{property:"c_PAHLD",operator:"=",value:!0});Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["FormattedID","ScheduleState","Project","PortfolioItem"],context:{project:"/project/11089755042",projectScopeDown:!0},limit:1/0,filters:HLDFilter,autoLoad:!0,listeners:{scope:this,load:function(myStore,myData,mySuccess){console.log("Loaded user story data: "+myStore.data.length);var hld=Ext.create("Ext.util.HashMap"),hldgreenlit=Ext.create("Ext.util.HashMap");Ext.Array.each(myStore.getRecords(),function(userStory){var fID=userStory.get("FormattedID"),feature=userStory.get("PortfolioItem");if(null!==feature){var featureRef=feature._ref,featureRefID=featureRef.split("/").pop();if(features.get(featureRefID)){var featureID=features.get(featureRefID);console.log(featureID+" - HLD "+fID);var USProject=userStory.get("Project"),USProjectRef=USProject._ref,USProjectRefID=USProjectRef.split("/").pop();if(projectNames.get(USProjectRefID)&&projectPrograms.get(USProjectRefID)){this._addToHash(hld,USProjectRefID,1);var USState=userStory.get("ScheduleState");console.log(featureID+" - HLD "+fID+": "+projectNames.get(USProjectRefID)+" - "+USState),"Accepted"==USState&&this._addToHash(hldgreenlit,USProjectRefID,1)}}}},this),this._compileData(projectNames,projectPrograms,programs,total,reviewed,validated,hld,hldgreenlit)}}})},_compileData:function(projectNames,projectPrograms,programs,total,reviewed,validated,hld,hldgreenlit){Ext.define("featureData",{extend:"Ext.data.Model",fields:[{name:"item",type:"string"},{name:"total",type:"int"},{name:"reviewed",type:"int"},{name:"validated",type:"int"},{name:"hld",type:"int"},{name:"hldgreenlit",type:"int"}]});var featureStore=Ext.create("Ext.data.Store",{model:featureData}),programTotal=Ext.create("Ext.util.HashMap"),programReviewed=Ext.create("Ext.util.HashMap"),programValidated=Ext.create("Ext.util.HashMap"),programHLD=Ext.create("Ext.util.HashMap"),programHLDGreenlit=Ext.create("Ext.util.HashMap");for(projectNames.each(function(key,value,length){var projectID=key,projectName=value,projectProgram=projectPrograms.get(projectID),name=projectProgram+": "+projectName,totalTmp=0,reviewedTmp=0,validatedTmp=0,hldTmp=0,hldgreenlitTmp=0;total.get(projectID)&&(totalTmp=total.get(projectID),this._addToHash(programTotal,projectProgram,totalTmp)),reviewed.get(projectID)&&(reviewedTmp=reviewed.get(projectID),this._addToHash(programReviewed,projectProgram,reviewedTmp)),validated.get(projectID)&&(validatedTmp=validated.get(projectID),this._addToHash(programValidated,projectProgram,validatedTmp)),hld.get(projectID)&&(hldTmp=hld.get(projectID),this._addToHash(programHLD,projectProgram,hldTmp)),hldgreenlit.get(projectID)&&(hldgreenlitTmp=hldgreenlit.get(projectID),this._addToHash(programHLDGreenlit,projectProgram,hldgreenlitTmp)),console.log("project: "+name+", total: "+totalTmp+", reviewed: "+reviewedTmp+", validated: "+validatedTmp+", hld: "+hldTmp+", hldgreenlit: "+hldgreenlitTmp),featureStore.add({item:name,total:totalTmp,reviewed:reviewedTmp,validated:validatedTmp,hld:hldTmp,hldgreenlit:hldgreenlitTmp})},this),i=0;programs.length>i;i++){var programTmp=programs[i],totalTmp=0,reviewedTmp=0,validatedTmp=0,hldTmp=0,hldgreenlitTmp=0;programTotal.get(programTmp)&&(totalTmp=programTotal.get(programTmp)),programReviewed.get(programTmp)&&(reviewedTmp=programReviewed.get(programTmp)),programValidated.get(programTmp)&&(validatedTmp=programValidated.get(programTmp)),programHLD.get(programTmp)&&(hldTmp=programHLD.get(programTmp)),programHLDGreenlit.get(programTmp)&&(hldgreenlitTmp=programHLDGreenlit.get(programTmp)),console.log("project: "+programTmp+", total: "+totalTmp+", reviewed: "+reviewedTmp+", validated: "+validatedTmp+", hld: "+hldTmp+", hldgreenlit: "+hldgreenlitTmp),featureStore.add({item:programTmp,total:totalTmp,reviewed:reviewedTmp,validated:validatedTmp,hld:hldTmp,hldgreenlit:hldgreenlitTmp})}console.log(featureStore),this._loadGrid(featureStore)},_loadGrid:function(myStore){var myGrid=Ext.create("Ext.grid.Panel",{title:"PT Dashboard",store:myStore,columns:[{text:"Program",dataIndex:"item",width:300},{text:"Current Features",dataIndex:"total"},{text:"Reviewed Features",dataIndex:"reviewed"},{text:"Validated Features",dataIndex:"validated"},{text:"HLDs",dataIndex:"hld"},{text:"HLDs Greenlit",dataIndex:"hldgreenlit"}]});myGrid.store.sort([{property:"item",direction:"ASC"}]),console.log(myStore),this.add(myGrid)}});

            Rally.launchApp('CustomApp', {
                name:"RallyGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
